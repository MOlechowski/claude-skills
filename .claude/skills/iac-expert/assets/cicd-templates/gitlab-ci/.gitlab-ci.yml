# GitLab CI/CD Pipeline for Terraform
#
# Features:
# - Multi-environment support (dev, staging, prod)
# - Plan on merge request, apply on merge
# - Security scanning with Checkov
# - Cost estimation with Infracost

stages:
  - validate
  - security
  - plan
  - apply

variables:
  TF_ROOT: ${CI_PROJECT_DIR}
  TF_VERSION: "1.6.0"
  AWS_DEFAULT_REGION: "us-east-1"

image:
  name: hashicorp/terraform:${TF_VERSION}
  entrypoint: [""]

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - ${TF_ROOT}/.terraform

# Templates
.terraform-init: &terraform-init
  before_script:
    - cd ${TF_ROOT}/environments/${ENVIRONMENT}
    - terraform init

.terraform-plan: &terraform-plan
  script:
    - terraform plan -out=plan.tfplan -var-file=terraform.tfvars
  artifacts:
    paths:
      - ${TF_ROOT}/environments/${ENVIRONMENT}/plan.tfplan
    expire_in: 1 week

.terraform-apply: &terraform-apply
  script:
    - terraform apply -auto-approve plan.tfplan

# Validate Stage
validate:
  stage: validate
  script:
    - terraform fmt -check -recursive
    - |
      for env in dev staging prod; do
        echo "Validating $env"
        cd ${TF_ROOT}/environments/$env
        terraform init -backend=false
        terraform validate
        cd ${TF_ROOT}
      done
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Security Stage
security-scan:
  stage: security
  image:
    name: bridgecrew/checkov:latest
    entrypoint: [""]
  script:
    - checkov -d ${TF_ROOT} --framework terraform --soft-fail
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: true

# Plan Stage
plan:dev:
  stage: plan
  variables:
    ENVIRONMENT: dev
  <<: *terraform-init
  <<: *terraform-plan
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

plan:staging:
  stage: plan
  variables:
    ENVIRONMENT: staging
  <<: *terraform-init
  <<: *terraform-plan
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

plan:prod:
  stage: plan
  variables:
    ENVIRONMENT: prod
  <<: *terraform-init
  <<: *terraform-plan
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Apply Stage
apply:dev:
  stage: apply
  variables:
    ENVIRONMENT: dev
  <<: *terraform-init
  <<: *terraform-apply
  dependencies:
    - plan:dev
  environment:
    name: dev
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  needs:
    - job: plan:dev
      optional: true

apply:staging:
  stage: apply
  variables:
    ENVIRONMENT: staging
  <<: *terraform-init
  <<: *terraform-apply
  dependencies:
    - plan:staging
  environment:
    name: staging
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  needs:
    - job: apply:dev

apply:prod:
  stage: apply
  variables:
    ENVIRONMENT: prod
  <<: *terraform-init
  <<: *terraform-apply
  dependencies:
    - plan:prod
  environment:
    name: production
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  needs:
    - job: apply:staging
